<head>
    <title>Master Controls - D&D Map</title>
    <link rel="stylesheet" href="styles.css">
    <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>
    <!-- <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script> -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <!-- <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script> -->
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
</head>
<body>
    <div id="master-controls"></div>
    <script type="text/babel">
        const masterControlsEl = document.getElementById('master-controls');

        const convertBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.readAsDataURL(file);

                fileReader.onload = () => {
                    resolve(fileReader.result);
                };

                fileReader.onerror = (error) => {
                    reject(error);
                };
            });
        };

        async function uploadURL(URL) {
            let formData = new FormData();
            formData.append('URL', URL);
            await fetch('/uploadURL', {
                method: 'POST',
                body: formData
            });
        }

        async function uploadFile(file) {
            const base64Img = await convertBase64(file);
            let formData = new FormData();
            formData.append('file', base64Img);
            await fetch('/uploadFile', {
                method: 'POST',
                body: formData
            });
        }

        async function uploadScaleFactor(currentScale) {
            let formData = new FormData();
            formData.append('scaleFactor', currentScale);
            await fetch('/uploadScaleFactor', {
                method: 'POST',
                body: formData
            });
        }

        async function uploadXOffset(currentXOffset) {
            let formData = new FormData();
            formData.append('xOffset', currentXOffset);
            await fetch('/uploadXOffset', {
                method: 'POST',
                body: formData
            });
        }

        async function uploadYOffset(currentYOffset) {
            let formData = new FormData();
            formData.append('yOffset', currentYOffset);
            await fetch('/uploadYOffset', {
                method: 'POST',
                body: formData
            });
        }

        class MasterControls extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    imageSrc: '',
                    scaleFactor: 1.0,
                    xOffset: 0,
                    yOffset: 0
                }
                this.loadMap = this.loadMap.bind(this);
                this.loadMap();
            }

            resetZoom() {
                uploadScaleFactor(1.0);
                uploadXOffset(0);
                uploadYOffset(0);
                this.setState({
                    scaleFactor: 1.0,
                    xOffset: 0,
                    yOffset: 0
                })
            }

            increaseScaleFactor() {
                let currentScale = parseFloat(this.state.scaleFactor).toFixed(1);
                let newScaleFactor = parseFloat(currentScale) + parseFloat(0.1);
                uploadScaleFactor(newScaleFactor);
                this.setState({
                    scaleFactor: newScaleFactor
                });
            }

            decreaseScaleFactor() {
                let currentScale = parseFloat(this.state.scaleFactor).toFixed(1);
                let newScaleFactor = parseFloat(currentScale) - parseFloat(0.1);
                uploadScaleFactor(newScaleFactor);
                this.setState({
                    scaleFactor: newScaleFactor
                });
            }

            increaseXOffset() {
                let currentXOffset = parseFloat(this.state.xOffset).toFixed();
                let newXOffset = parseFloat(currentXOffset) + parseFloat(10);
                uploadXOffset(newXOffset);
                this.setState({
                    xOffset: newXOffset
                })
            }

            decreaseXOffset() {
                let currentXOffset = parseFloat(this.state.xOffset).toFixed();
                let newXOffset = parseFloat(currentXOffset) - parseFloat(10);
                uploadXOffset(newXOffset);
                this.setState({
                    xOffset: newXOffset
                })
            }

            increaseYOffset() {
                let currentYOffset = parseFloat(this.state.yOffset).toFixed();
                let newYOffset = parseFloat(currentYOffset) + parseFloat(10);
                uploadYOffset(newYOffset);
                this.setState({
                    yOffset: newYOffset
                })
            }

            decreaseYOffset() {
                let currentYOffset = parseFloat(this.state.yOffset).toFixed();
                let newYOffset = parseFloat(currentYOffset) - parseFloat(10);
                uploadYOffset(newYOffset);
                this.setState({
                    yOffset: newYOffset
                })
            }

            _handleKeyDown = (event) => {
                switch(event.keyCode) {
                    case 37:
                        this.decreaseXOffset();
                        break;
                    case 38:
                        this.decreaseYOffset();
                        break;
                    case 39:
                        this.increaseXOffset();
                        break;
                    case 40:
                        this.increaseYOffset();
                        break;
                    case 48:
                        this.resetZoom();
                        break;
                    case 96:
                        this.resetZoom();
                        break;
                    case 107:
                        this.increaseScaleFactor();
                        break;
                    case 109:
                        this.decreaseScaleFactor();
                        break;
                    case 187:
                        this.increaseScaleFactor();
                        break;
                    case 189:
                        this.decreaseScaleFactor();
                        break;
                    default:
                        //Don't do nothing
                }
                //console.log(`Key: ${event.key} with keycode ${event.keyCode} has been pressed`);
            }

            componentDidMount() {
                document.addEventListener("keydown", this._handleKeyDown);
            }

            componentWillUnmount() {
                document.removeEventListener("keydown", this._handleKeyDown);
            }

            loadMap() {
                var req = new XMLHttpRequest();
                req.overrideMimeType("application/json");
                req.open('GET', '/loadMap', true);
                req.onload  = function() {
                    let jsonResponse = JSON.parse(req.responseText);
                    this.setState({
                        imageSrc: jsonResponse.mapImage,
                        scaleFactor: jsonResponse.scaleFactor,
                        xOffset: 0,
                        yOffset: 0
                    });
                }.bind(this);
                req.send(null);
            }

            handleURLChange(event) {
                let imageURL = event.target.value;
                if (
                    (
                        imageURL.startsWith('http://') || imageURL.startsWith('https://')
                    ) && (
                        imageURL.endsWith('.png') ||
                        imageURL.endsWith('.jpg') ||
                        imageURL.endsWith('.jpeg') ||
                        imageURL.endsWith('.webp')
                    )
                ) {
                    uploadURL(imageURL);
                    uploadScaleFactor(1.0);
                    this.setState({
                        imageSrc: imageURL,
                        scaleFactor: 1.0
                    })
                }
            }

            handleImageFile(event) {
                var file = event.target.files[0];
                uploadFile(file);
                uploadScaleFactor(1.0);
                this.setState({
                    imageSrc: URL.createObjectURL(file),
                    scaleFactor: 1.0
                })
            }
            
            render() {
                return (
                    <div>
                        <div id="map-header">
                            <label htmlFor="mapurl">Paste link to map: </label>
                            <input type="text" id="mapurl" name="mapurl" onChange={(e) => this.handleURLChange(e)}/> or 
                            <label htmlFor="myfile"> choose a map file: </label>
                            <input type="file" id="mapfile" name="mapfile" accept="image/*" onChange={(e) => this.handleImageFile(e)}></input><br/>
                        </div>
                        <div id="map-view" onKeyPress={this.handleAnswerChange}>
                            <img 
                                style={{
                                    transform: `scale(${this.state.scaleFactor}) translate(${this.state.xOffset}px, ${this.state.yOffset}px)`
                                }}
                                src={this.state.imageSrc}
                            />
                        </div>
                    </div>
                );
            }
        }
        ReactDOM.render(<MasterControls/>, masterControlsEl);
    </script>
</body>
